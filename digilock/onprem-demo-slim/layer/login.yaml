# METABEGIN
# X-Env-Layer-Name: login
# X-Env-Layer-Category: layer
# X-Env-Layer-Desc: Install Login, creates user and installs any dev tools
# X-Env-Layer-Requires: v8-svelte
#
# X-Env-VarRequires: IGconf_device_user1
# X-Env-VarRequires-Valid: string
#
# X-Env-VarRequires: IGconf_device_user1pass
# X-Env-VarRequires: IGconf_device_production
# METAEND
---
mmdebstrap:
  packages:
    - passwd
    - libpam-runtime
    - login
    # Dev tools
    - nano
    - ncurses-term

  customize-hooks:
    - |-
      # Always create the main user
      chroot $1 sh -c "useradd -m -s /bin/bash -u 4000 $IGconf_device_user1"

      # Set user password if provided
      if [ -n "$IGconf_device_user1pass" ]; then
        chroot $1 sh -c "printf '%s:%s\n' '${IGconf_device_user1}' '${IGconf_device_user1pass}' | chpasswd"
      fi

      # Only set root password in non-production mode
      if [ "$IGconf_device_production" != "true" ] && [ -n "$IGconf_device_user1pass" ]; then
        chroot $1 sh -c "printf '%s:%s\n' 'root' '${IGconf_device_user1pass}' | chpasswd"
      fi

      # If production mode, disable root
      if [ "$IGconf_device_production" = "true" ]; then
        chroot $1 usermod --pass='*' root
      fi

    # dev tools
    - chroot $1 sh -c "echo 'export TERM=xterm' >> /etc/profile.d/term.sh"
