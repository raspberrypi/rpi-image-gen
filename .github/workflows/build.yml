name: Build Images

on: 
  workflow_dispatch:
    inputs:
      NL_On_Prem_Auth_Tag:
        description: "OnPrem release tag (For example v0.0.5). Leave empty to download latest release."
        required: false
        default: ""
  workflow_call:
    inputs:
      NL_On_Prem_Auth_Tag:
        required: true
        type: string
    secrets:
      GH_PAT:
        required: true

jobs:
  build:
    runs-on:
      - self-hosted
      - linux
      - arm64

    steps:
      - name: Fix workspace permissions
        run: |
          sudo rm -rf "$GITHUB_WORKSPACE"/work

      - uses: actions/checkout@v5

      - name: Generate dynamic config file
        run: |
          VERSION="${{ inputs.NL_On_Prem_Auth_Tag }}"
          VERSION="${VERSION}"

          TEMPLATE="digilock/onprem-demo-slim/config/pi5-onprem-demo-network-prod.yaml.template"
          OUTPUT="digilock/onprem-demo-slim/config/pi5-onprem-demo-network-prod.yaml"

          sed "s/__VERSION__/${VERSION}/g" "$TEMPLATE" > "$OUTPUT"

          echo "Generated config:"
          cat "$OUTPUT" 

      # -------------------------------
      # Downloading the selected release
      # -------------------------------
      - name: Download NL-On-Prem-Auth release artifact (latest or specific)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          RELEASE_TAG: ${{ inputs.NL_On_Prem_Auth_Tag }}
        run: |
          mkdir -p artifacts

          if [ -z "$RELEASE_TAG" ]; then
            echo "No tag provided → downloading latest release"
            gh release download \
              --repo SecurityPeopleInc/NL-On-Prem-Auth \
              --latest \
              --pattern "digilink-onprem-*-arm64.tar.gz" \
              --dir artifacts
          else
            echo "Using tag: $RELEASE_TAG"
            gh release download \
              "$RELEASE_TAG" \
              --repo SecurityPeopleInc/NL-On-Prem-Auth \
              --pattern "digilink-onprem-${RELEASE_TAG}-arm64.tar.gz" \
              --dir artifacts
          fi

          echo "Downloaded artifacts:"
          ls -al artifacts

      # ---------------------------------------
      # Copy, extract, and prepare rootfs files
      # ---------------------------------------
      - name: Place release files into rootfs-overlay
        run: |
          set -e

          DEST="digilock/onprem-demo-slim/device/mypi5/device/rootfs-overlay/opt"

          echo "Finding downloaded tar.gz..."
          TARFILE=$(ls artifacts/*.tar.gz | head -n 1)
          echo "Using: $TARFILE"

          echo "Copying tar.gz into destination..."
          cp "$TARFILE" "$DEST/"

          echo "Extracting..."
          cd "$DEST"
          tar -xzvf "$(basename "$TARFILE")"

          echo "Removing original tar..."
          rm "$(basename "$TARFILE")"

          echo "Renaming extracted folder → digilink-onprem"
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "digilink-onprem*" | head -n 1)

          if [ -z "$EXTRACTED_DIR" ]; then
            echo "ERROR: Could not find extracted directory"
            exit 1
          fi

          mv "$EXTRACTED_DIR" digilink-onprem

          echo "Final directory contents:"
          ls

      - name: Install dependencies
        run: |
          sudo ./install_deps.sh

      - name: Run image generator
        run: |
          ./rpi-image-gen build -S ./digilock/onprem-demo-slim/ -c pi5-onprem-demo-network-prod.yaml

      - name: Zip image
        run: |
          IMG="./work/image-onprem-demo-network-${{ inputs.NL_On_Prem_Auth_Tag }}/onprem-demo-network-${{ inputs.NL_On_Prem_Auth_Tag }}.img"
          ZIP="./work/image-onprem-demo-network-${{ inputs.NL_On_Prem_Auth_Tag }}/onprem-demo-network-${{ inputs.NL_On_Prem_Auth_Tag }}.zip"

          echo "Zipping image..."
          zip -j "$ZIP" "$IMG"

          echo "Final zip:"
          ls -lh "$ZIP"
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-onprem-demo-image-network
          path: ./work/image-onprem-demo-network-${{ inputs.NL_On_Prem_Auth_Tag }}/onprem-demo-network-${{ inputs.NL_On_Prem_Auth_Tag }}.zip
          compression-level: 0
