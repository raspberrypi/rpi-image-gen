# METABEGIN
# X-Env-Layer-Name: rpi-connect-ota
# X-Env-Layer-Category: service
# X-Env-Layer-Desc: Configures Raspberry Pi Connect's experimental remote update capability
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-RequiresProvider: rpi-connect-client
#
# X-Env-VarRequires: IGconf_device_user1
# X-Env-VarRequires-Valid: string
# METAEND
---
mmdebstrap:
  packages:
    - rpi-connect-ota

  customize-hooks:
  - |-
    set -eu

    # Enable experimental remote update support in rpi-connectd
    cat <<-EOF > $1/etc/default/rpi-connect
    RPI_CONNECT_EXPERIMENTAL_OTA=t
    EOF

    # Configure D-Bus service for rpi-connect remote update
    cat <<-EOF > $1/usr/share/dbus-1/system.d/com.raspberrypi.Connect1.RemoteUpdateManager.conf
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE busconfig PUBLIC
     "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
     "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
    <busconfig>
      <!-- Allow ${IGconf_device_user1} to offer this service -->
      <policy user="${IGconf_device_user1}">
        <allow own="com.raspberrypi.Connect1.RemoteUpdateManager"/>
      </policy>

      <!-- Allow root to call this service -->
      <policy user="root">
        <allow send_destination="com.raspberrypi.Connect1.RemoteUpdateManager"
               send_interface="com.raspberrypi.Connect1.RemoteUpdateManager"/>

        <allow send_destination="com.raspberrypi.Connect1.RemoteUpdateManager"
               send_interface="org.freedesktop.DBus.Introspectable"/>
      </policy>
    </busconfig>
    EOF
